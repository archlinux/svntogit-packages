# $Id: $
# Maintainer: Jan de Groot <jgc@archlinux.org>

pkgname=uclibc
pkgver=0.9.30.1
pkgrel=2
pkgdesc="C library for developing embedded Linux systems"
arch=(i686 x86_64)
url="http://www.uclibc.org/"
license=('LGPL')
source=(http://www.uclibc.org/downloads/uClibc-${pkgver}.tar.bz2
        0.9.30-branch.patch
        unifdef.patch
	config)

build() {
  cd "${srcdir}/uClibc-${pkgver}"
  _thost="${CHOST/gnu/uclibc}"
  if [ "${CARCH}" = "x86_64" ]; then
    _ld="ld64-uClibc"
  else
    _ld="ld-uClibc"
  fi
  cd extra
  patch -Np1 -i "${srcdir}/unifdef.patch" || return 1
  cd ..
  patch -Np1 -i "${srcdir}/0.9.30-branch.patch" || return 1
  cp "${srcdir}/config" .config
  make || return 1
  make DESTDIR="${pkgdir}" install || return 1

  mkdir "${pkgdir}/lib"
  mv "${pkgdir}/usr/x86_64-unknown-linux-uclibc/lib/${_ld}-${pkgver}.so" \
     "${pkgdir}/lib/" || return 1
  ln -s ld64-uClibc-${pkgver}.so "${pkgdir}/lib/${_ld}.so.0" || return 1
  ln -s /lib/${_ld}-${pkgver}.so "${pkgdir}/usr/${_thost}/lib/" || return 1

  ln -s /usr/include/{asm,asm-generic,linux,mtd,rdma,sound,video} "${pkgdir}/usr/${_thost}/include/" || return 1

  ln -s include "${pkgdir}/usr/${_thost}/sys-include" || return 1
}
