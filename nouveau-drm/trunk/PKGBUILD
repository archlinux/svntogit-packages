# $Id$
# Maintainer: Andreas Radke <andyrtr@archlinux.org>
# Contributor: buddabrod <buddabrod@gmail.com>

pkgname=nouveau-drm
pkgver=20090612
_gitdate=20090612
_kernver='2.6.30-ARCH'
pkgrel=1
pkgdesc="nvidia opensource X driver"
arch=('i686' 'x86_64')
url="http://nouveau.freedesktop.org/"
makedepends=('git' 'autoconf' 'pkgconfig')
depends=("kernel26>=2.6.30" "kernel26<2.6.31" 'udev>=141' 'cairo')
install=${pkgname}.install
license=('GPL')
md5sums=()
source=(ftp://ftp.archlinux.org/other/$pkgname/mesa-drm-${_gitdate}.tar.bz2
	dont_check_for_pthread.patch)
md5sums=('b673761e0e64546638fc533b91da801a'
         '237f3cdb1bfc5c62bfa7b038b7a20b2a')

build() {
  # get git code
#  cd ${srcdir}
#  git clone -v git://anongit.freedesktop.org/git/mesa/drm/
#  cd drm
#  git archive --prefix=mesa-drm-${_gitdate}/ --format=tar HEAD | bzip2 > ../../mesa-drm-${_gitdate}.tar.bz2
#  return 1

  # build the drm kernel module
  # make sure the system kernel doesn't have "drm" set to "yes", 
  # default Arch kernel26 has it as module drm.ko, make sure it's not loaded
  cd ${srcdir}/mesa-drm-${_gitdate}
  patch -Np0 -i ${srcdir}/dont_check_for_pthread.patch || return 1
  ./autogen.sh --prefix=/usr --enable-nouveau-experimental-api --enable-udev
  cd linux-core
  make DRM_MODULES="nouveau" || return 1
  install -D -m 0644 drm.ko ${pkgdir}/lib/modules/`uname -r`/updates/drm.ko || return 1
  install -D -m 0644 nouveau.ko ${pkgdir}/lib/modules/`uname -r`/kernel/drivers/video/nouveau.ko || return 1
  install -D -m 0644 ../shared-core/nouveau_drm.h ${pkgdir}/usr/include/nouveau_drm.h || return 1

  # install script
  sed -i -e "s/KERNEL_VERSION='.*'/KERNEL_VERSION='${_kernver}'/" $startdir/nvidia.install
}

