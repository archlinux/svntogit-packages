# Maintainer: David Runge <dave@sleepmap.de>
# Contributor: Ray Rashif <schiv@archlinux.org>
# Contributor: damir <damir@archlinux.org>
# Contributor: Lukas Sabota <punkrockguy318@comcast.net>
# Contributor: Brice Carpentier <brice@dlfp.org>

pkgname=scons
pkgver=3.1.0
pkgrel=2
pkgdesc="Extensible Python-based build utility"
arch=('any')
url="https://scons.org"
license=('MIT')
depends=('python')
makedepends=('python-setuptools')
# potential additions include ipkg, rpm
checkdepends=('clang' 'dmd' 'gdc' 'ldc' 'nasm' 'python-lxml' 'python-pytest'
'python-virtualenv' 'swig' 'zip')
source=("$pkgname-$pkgver.tar.gz::https://github.com/${pkgname}/${pkgname}/archive/${pkgver}.tar.gz")
sha512sums=('3894d17bca02b9aa5426c70d894b8ecfcf3db2b20254b848209c31d8413a8cd1c2a7b2a87ef9bcfe5555980beb2815f62cdbe185098a64ae8b3506c41c867463')

prepare() {
  cd "${pkgname}-${pkgver}"
  # emulate a release
  local _copyright='Copyright (c) 2001 - 2019 The SCons Foundation'
  local _date_of_release="$(grep "RELEASE ${pkgver}" src/CHANGES.txt | cut -d ',' -f2)"
  local _date="$(date -d "${_date_of_release}" +'%Y-%m-%d %H:%M:%S')"
  # copy scripts to correct locations and change their globals
  for _script in scons{,ign,-time,-configure-cache}; do
    cp -v "src/script/${_script}.py" "src/script/${_script}"
    sed -e "s|__COPYRIGHT__|${_copyright}|g" \
        -e "s|__FILE__|/src/script/${_script}|g" \
        -e 's/__REVISION__/none/g' \
        -e "s|__DATE__|${_date}|g" \
        -e 's/__BUILDSYS__/none/g' \
        -e 's/__DEVELOPER__/none/g' \
        -e "s/__VERSION__/${pkgver}/g" \
        -i "src/script/${_script}"
  done
  sed -e "s|__COPYRIGHT__|${_copyright}|g" \
      -e 's|__FILE__|/src/setup.py|g' \
      -e 's/__REVISION__/none/g' \
      -e "s|__DATE__|${_date}|g" \
      -e 's/__BUILDSYS__/none/g' \
      -e 's/__DEVELOPER__/none/g' \
      -e "s/__VERSION__/${pkgver}/g" \
      -i "src/setup.py"
}

build() {
  cd "${pkgname}-${pkgver}"
  # build man page and move to src directory
  python bootstrap.py doc/SConscript
  mv -v build/doc/man/* src/
  cd src
  python setup.py build
}

check() {
  cd "${pkgname}-${pkgver}"
  python runtest.py -a -t || msg "Tests passing with 'NO RESULT' count as failed."
}

package() {
  cd "${pkgname}-${pkgver}/src"
  python setup.py install --prefix=/usr \
                          --skip-build \
                          --optimize=1 \
                          --standard-lib \
                          --install-data=/usr/share \
                          --root="$pkgdir"
  install -vDm 644 LICENSE.txt -t "${pkgdir}/usr/share/licenses/${pkgname}/"
  install -vDm 644 {CHANGES,README,RELEASE}.txt \
    -t "${pkgdir}/usr/share/doc/${pkgname}/"
  # removing Windows only script
  rm -vf "${pkgdir}/usr/bin/scons"*.bat
}
