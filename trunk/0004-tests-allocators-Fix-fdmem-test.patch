From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: "Jan Alexander Steffens (heftig)" <heftig@archlinux.org>
Date: Mon, 10 Apr 2023 16:06:19 +0200
Subject: [PATCH] tests: allocators: Fix fdmem test

Since the test wants to close the FD itself, we need to tell the FD
allocator not to. Otherwise the test will fail with recent GLib, which
emits a critical warning on EBADF.
---
 subprojects/gst-plugins-base/tests/check/libs/allocators.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/subprojects/gst-plugins-base/tests/check/libs/allocators.c b/subprojects/gst-plugins-base/tests/check/libs/allocators.c
index 6b974b2900e9..da08ae0176fc 100644
--- a/subprojects/gst-plugins-base/tests/check/libs/allocators.c
+++ b/subprojects/gst-plugins-base/tests/check/libs/allocators.c
@@ -80,22 +80,23 @@ GST_START_TEST (test_fdmem)
 
   alloc = gst_fd_allocator_new ();
   fail_unless (alloc);
-  mem = gst_fd_allocator_alloc (alloc, fd, 10, GST_FD_MEMORY_FLAG_KEEP_MAPPED);
+  mem = gst_fd_allocator_alloc (alloc, fd, 10,
+      GST_FD_MEMORY_FLAG_KEEP_MAPPED | GST_FD_MEMORY_FLAG_DONT_CLOSE);
 
   fail_unless (gst_memory_map (mem, &info, GST_MAP_READ));
   fail_unless (info.data[5] == '5');
   gst_memory_unmap (mem, &info);
 
   fail_unless (gst_memory_map (mem, &info, GST_MAP_WRITE));
   info.data[5] = 'X';
   gst_memory_unmap (mem, &info);
 
   fail_unless (gst_memory_map (mem, &info, GST_MAP_READ));
   fail_unless (info.data[5] == 'X');
   gst_memory_unmap (mem, &info);
 
   gst_memory_unref (mem);
-  fail_unless (g_close (fd, NULL) == 0);
+  fail_unless (g_close (fd, NULL));
   gst_object_unref (alloc);
 }
 
